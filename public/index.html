<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>URL Shortener with Analytics</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      }

      .gradient-bg {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      }

      .card-outline {
        border: 1.5px solid #e5e7eb;
        transition: all 0.3s ease;
      }

      .card-outline:hover {
        border-color: #d1d5db;
        background-color: #fafafa;
      }

      .input-outline {
        border: 1.5px solid #e5e7eb;
        transition: border-color 0.3s ease, background-color 0.3s ease;
      }

      .input-outline:focus {
        border-color: #6366f1;
        background-color: #f8f7ff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border: 1.5px solid #6366f1;
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        border-color: #4f46e5;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      }

      .btn-outline {
        border: 1.5px solid #e5e7eb;
        background: white;
        transition: all 0.3s ease;
      }

      .btn-outline:hover {
        border-color: #6366f1;
        background-color: #f8f7ff;
        color: #6366f1;
      }

      .stat-card {
        border: 1.5px solid #e5e7eb;
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        border-color: #6366f1;
        background-color: #f8f7ff;
      }

      .section-title {
        font-size: 1.875rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1.5rem;
      }

      @media (max-width: 768px) {
        .section-title {
          font-size: 1.5rem;
        }
      }

      html, body {
        height: 100%;
      }

      body {
        display: flex;
        flex-direction: column;
      }

      main {
        flex: 1;
      }
    </style>
  </head>
  <body class="bg-white">
    <!-- Header -->
    <header class="gradient-bg text-white py-8 mb-12 border-b border-indigo-200">
      <div class="container mx-auto px-4 md:px-6">
        <div class="text-center">
          <h1 class="text-3xl md:text-4xl font-bold mb-2">
            <i class="fas fa-link mr-2"></i>URL Shortener
          </h1>
          <p class="text-indigo-100 text-sm md:text-lg">
            Shorten your links and track analytics in real-time
          </p>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main>
    <div class="container mx-auto px-4 md:px-6 max-w-4xl pb-12">
      <!-- URL Shortening Form -->
      <div class="bg-white card-outline rounded-2xl p-6 md:p-8 mb-8">
        <h2 class="section-title">
          <i class="fas fa-scissors mr-2 text-indigo-600"></i>Shorten Your URL
        </h2>

        <form id="shortenForm" class="space-y-4">
          <div>
            <label
              for="originalUrl"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              Enter Long URL <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="originalUrl"
              name="originalUrl"
              placeholder="https://example.com/very/long/url/that/needs/shortening"
              required
              class="w-full px-4 py-3 input-outline rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"
            />
          </div>

          <button
            type="submit"
            class="w-full btn-primary text-white font-semibold py-3 px-6 rounded-xl hover:shadow-lg transition duration-200 flex items-center justify-center gap-2 text-sm md:text-base"
          >
            <i class="fas fa-wand-magic-sparkles"></i>Shorten URL
          </button>
        </form>

        <!-- Result Display -->
        <div
          id="resultContainer"
          class="hidden mt-6 p-4 md:p-6 bg-green-50 border-1.5 border-green-300 rounded-xl"
        >
          <p class="text-sm font-medium text-green-800 mb-3">
            âœ“ Your shortened URL:
          </p>
          <div class="flex flex-col sm:flex-row gap-2">
            <input
              type="text"
              id="shortUrlDisplay"
              readonly
              class="flex-1 px-4 py-2 bg-white border-1.5 border-green-300 rounded-lg text-green-700 font-mono text-sm"
            />
            <div class="flex gap-2">
              <button
                onclick="copyUrl()"
                class="btn-outline text-gray-700 px-4 py-2 rounded-lg hover:bg-green-50 transition flex items-center justify-center gap-1 whitespace-nowrap"
                title="Copy to clipboard"
              >
                <i class="fas fa-copy"></i>
                <span class="hidden sm:inline text-sm">Copy</span>
              </button>
            </div>
          </div>
          <p id="expirationInfo" class="text-xs text-gray-600 mt-3 hidden"></p>
        </div>

        <!-- Error Display -->
        <div
          id="errorContainer"
          class="hidden mt-6 p-4 md:p-6 bg-red-50 border-1.5 border-red-300 rounded-xl"
        >
          <p class="text-sm font-medium text-red-800" id="errorMessage"></p>
        </div>
      </div>

      <!-- Analytics Dashboard -->
      <div id="analyticsSection" class="hidden">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
          <h2 class="section-title m-0">
            <i class="fas fa-chart-bar mr-2 text-indigo-600"></i>Analytics Dashboard
          </h2>
          <button
            onclick="refreshAnalytics()"
            class="btn-primary text-white px-4 py-2 rounded-lg hover:shadow-lg transition flex items-center gap-2 text-sm"
          >
            <i class="fas fa-sync-alt"></i><span class="hidden sm:inline">Refresh</span>
          </button>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
          <div class="bg-white stat-card rounded-xl p-4 md:p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-xs md:text-sm mb-1">Total Clicks</p>
                <p id="totalClicks" class="text-2xl md:text-3xl font-bold text-indigo-600">
                  0
                </p>
              </div>
              <i class="fas fa-mouse-pointer text-2xl md:text-4xl text-indigo-100"></i>
            </div>
          </div>

          <div class="bg-white stat-card rounded-xl p-4 md:p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-xs md:text-sm mb-1">Countries</p>
                <p
                  id="totalCountries"
                  class="text-2xl md:text-3xl font-bold text-purple-600"
                >
                  0
                </p>
              </div>
              <i class="fas fa-globe text-2xl md:text-4xl text-purple-100"></i>
            </div>
          </div>

          <div class="bg-white stat-card rounded-xl p-4 md:p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-xs md:text-sm mb-1">Created</p>
                <p id="createdDate" class="text-lg font-semibold text-cyan-600">
                  -
                </p>
              </div>
              <i class="fas fa-calendar text-2xl md:text-4xl text-cyan-100"></i>
            </div>
          </div>

          <div class="bg-white stat-card rounded-xl p-4 md:p-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-gray-500 text-xs md:text-sm mb-1">Short Code</p>
                <p
                  id="shortCodeDisplay"
                  class="text-lg font-mono font-semibold text-pink-600 truncate"
                >
                  -
                </p>
              </div>
              <i class="fas fa-link text-2xl md:text-4xl text-pink-100"></i>
            </div>
          </div>
        </div>

        <!-- URL Info -->
        <div class="bg-white card-outline rounded-xl p-4 md:p-6 mb-8">
          <h3 class="text-lg font-semibold mb-3 text-gray-800">Original URL</h3>
          <p id="originalUrlDisplay" class="text-gray-600 break-all text-sm">-</p>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Clicks Over Time Chart -->
          <div class="bg-white card-outline rounded-xl p-4 md:p-6">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">
              Clicks Over Time
            </h3>
            <div class="relative h-64">
              <canvas id="clicksOverTimeChart"></canvas>
            </div>
          </div>

          <!-- Clicks by Country Chart -->
          <div class="bg-white card-outline rounded-xl p-4 md:p-6">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">
              Clicks by Country
            </h3>
            <div class="relative h-64">
              <canvas id="countryChart"></canvas>
            </div>
          </div>

          <!-- Clicks by Device Chart -->
          <div class="bg-white card-outline rounded-xl p-4 md:p-6">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">
              Clicks by Device
            </h3>
            <div class="relative h-64">
              <canvas id="deviceChart"></canvas>
            </div>
          </div>

          <!-- Clicks by Browser Chart -->
          <div class="bg-white card-outline rounded-xl p-4 md:p-6">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">
              Clicks by Browser
            </h3>
            <div class="relative h-64">
              <canvas id="browserChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Recent Clicks Table -->
        <div class="bg-white card-outline rounded-xl p-4 md:p-6 mb-8">
          <h3 class="text-lg font-semibold mb-4 text-gray-800">
            Recent Clicks
          </h3>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"
                  >
                    Time
                  </th>
                  <th
                    class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider hidden sm:table-cell"
                  >
                    Location
                  </th>
                  <th
                    class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider hidden md:table-cell"
                  >
                    Device
                  </th>
                  <th
                    class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider hidden lg:table-cell"
                  >
                    Browser
                  </th>
                  <th
                    class="px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider hidden xl:table-cell"
                  >
                    Referer
                  </th>
                </tr>
              </thead>
              <tbody
                id="recentClicksTable"
                class="bg-white divide-y divide-gray-200"
              >
                <tr>
                  <td colspan="5" class="px-4 md:px-6 py-4 text-center text-gray-500 text-sm">
                    No clicks yet
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-gray-100 to-gray-50 text-gray-600 py-4 md:py-6 mt-8 md:mt-12 border-t border-gray-200">
      <div class="container mx-auto px-4 md:px-6 text-center text-xs md:text-sm">
        <p>
          &copy; 2024 URL Shortener with Analytics. Built with Express.js &
          MongoDB.
        </p>
      </div>
    </footer>

    <!-- JavaScript -->
    <script>
      let currentShortCode = null;
      let charts = {};

      // Form submission
      document
        .getElementById("shortenForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const originalUrl = document.getElementById("originalUrl").value;


          try {
            const response = await fetch("/api/shorten", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                originalUrl,
              }),
            });

            const data = await response.json();

            if (data.success) {
              // Hide error, show result
              document.getElementById("errorContainer").classList.add("hidden");
              document
                .getElementById("resultContainer")
                .classList.remove("hidden");
              document.getElementById("shortUrlDisplay").value = data.shortUrl;

              currentShortCode = data.shortCode;

              // Show expiration info if applicable
              if (data.expiresAt) {
                const expirationDate = new Date(
                  data.expiresAt
                ).toLocaleDateString();
                document.getElementById(
                  "expirationInfo"
                ).textContent = `Expires on: ${expirationDate}`;
                document
                  .getElementById("expirationInfo")
                  .classList.remove("hidden");
              } else {
                document
                  .getElementById("expirationInfo")
                  .classList.add("hidden");
              }

              // Clear form
              document.getElementById("shortenForm").reset();
            } else {
              // Show error
              document
                .getElementById("resultContainer")
                .classList.add("hidden");
              document
                .getElementById("errorContainer")
                .classList.remove("hidden");
              document.getElementById("errorMessage").textContent =
                data.message;
            }
          } catch (error) {
            console.error("Error:", error);
            document.getElementById("resultContainer").classList.add("hidden");
            document
              .getElementById("errorContainer")
              .classList.remove("hidden");
            document.getElementById("errorMessage").textContent =
              "Failed to shorten URL. Please try again.";
          }
        });

      // Copy URL to clipboard
      function copyUrl() {
        const shortUrlInput = document.getElementById("shortUrlDisplay");
        shortUrlInput.select();
        document.execCommand("copy");

        // Visual feedback
        const btn = event.target.closest("button");
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
          btn.innerHTML = originalHTML;
        }, 2000);
      }

      // View analytics
      function viewAnalytics() {
        if (currentShortCode) {
          loadAnalytics(currentShortCode);
        }
      }

      // Load analytics
      async function loadAnalytics(shortCode) {
        try {
          const response = await fetch(`/api/analytics/${shortCode}`);
          const data = await response.json();

          if (data.success) {
            // Show analytics section
            document
              .getElementById("analyticsSection")
              .classList.remove("hidden");

            // Update summary cards
            document.getElementById("totalClicks").textContent =
              data.totalClicks;
            document.getElementById("totalCountries").textContent = Object.keys(
              data.clicksByCountry
            ).length;
            document.getElementById("createdDate").textContent = new Date(
              data.createdAt
            ).toLocaleDateString();
            document.getElementById("shortCodeDisplay").textContent =
              data.shortCode;
            document.getElementById("originalUrlDisplay").textContent =
              data.originalUrl;

            // Render charts
            renderClicksOverTimeChart(data.clicksOverTime);
            renderCountryChart(data.clicksByCountry);
            renderDeviceChart(data.clicksByDevice);
            renderBrowserChart(data.clicksByBrowser);

            // Render recent clicks table
            renderRecentClicksTable(data.recentClicks);

            // Scroll to analytics
            document
              .getElementById("analyticsSection")
              .scrollIntoView({ behavior: "smooth" });
          }
        } catch (error) {
          console.error("Error loading analytics:", error);
          alert("Failed to load analytics. Please try again.");
        }
      }

      // Refresh analytics
      function refreshAnalytics() {
        if (currentShortCode) {
          loadAnalytics(currentShortCode);
        }
      }

      // Render clicks over time chart
      function renderClicksOverTimeChart(clicksOverTime) {
        const ctx = document.getElementById("clicksOverTimeChart");

        // Destroy existing chart
        if (charts.clicksOverTime) {
          charts.clicksOverTime.destroy();
        }

        charts.clicksOverTime = new Chart(ctx, {
          type: "line",
          data: {
            labels: clicksOverTime.map((item) =>
              new Date(item.date).toLocaleDateString()
            ),
            datasets: [
              {
                label: "Clicks",
                data: clicksOverTime.map((item) => item.count),
                borderColor: "rgb(147, 51, 234)",
                backgroundColor: "rgba(147, 51, 234, 0.1)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });
      }

      // Render country chart
      function renderCountryChart(clicksByCountry) {
        const ctx = document.getElementById("countryChart");

        if (charts.country) {
          charts.country.destroy();
        }

        const countries = Object.keys(clicksByCountry);
        const counts = Object.values(clicksByCountry);

        charts.country = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: countries,
            datasets: [
              {
                data: counts,
                backgroundColor: [
                  "rgba(147, 51, 234, 0.8)",
                  "rgba(79, 70, 229, 0.8)",
                  "rgba(59, 130, 246, 0.8)",
                  "rgba(14, 165, 233, 0.8)",
                  "rgba(20, 184, 166, 0.8)",
                  "rgba(34, 197, 94, 0.8)",
                  "rgba(234, 179, 8, 0.8)",
                  "rgba(249, 115, 22, 0.8)",
                  "rgba(239, 68, 68, 0.8)",
                  "rgba(236, 72, 153, 0.8)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
              },
            },
          },
        });
      }

      // Render device chart
      function renderDeviceChart(clicksByDevice) {
        const ctx = document.getElementById("deviceChart");

        if (charts.device) {
          charts.device.destroy();
        }

        const devices = Object.keys(clicksByDevice);
        const counts = Object.values(clicksByDevice);

        charts.device = new Chart(ctx, {
          type: "bar",
          data: {
            labels: devices,
            datasets: [
              {
                label: "Clicks",
                data: counts,
                backgroundColor: "rgba(99, 102, 241, 0.8)",
                borderColor: "rgb(99, 102, 241)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });
      }

      // Render browser chart
      function renderBrowserChart(clicksByBrowser) {
        const ctx = document.getElementById("browserChart");

        if (charts.browser) {
          charts.browser.destroy();
        }

        const browsers = Object.keys(clicksByBrowser);
        const counts = Object.values(clicksByBrowser);

        charts.browser = new Chart(ctx, {
          type: "pie",
          data: {
            labels: browsers,
            datasets: [
              {
                data: counts,
                backgroundColor: [
                  "rgba(239, 68, 68, 0.8)",
                  "rgba(249, 115, 22, 0.8)",
                  "rgba(234, 179, 8, 0.8)",
                  "rgba(34, 197, 94, 0.8)",
                  "rgba(20, 184, 166, 0.8)",
                  "rgba(14, 165, 233, 0.8)",
                  "rgba(59, 130, 246, 0.8)",
                  "rgba(99, 102, 241, 0.8)",
                  "rgba(147, 51, 234, 0.8)",
                  "rgba(236, 72, 153, 0.8)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "right",
              },
            },
          },
        });
      }

      // Render recent clicks table
      function renderRecentClicksTable(recentClicks) {
        const tbody = document.getElementById("recentClicksTable");

        if (recentClicks.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No clicks yet</td></tr>';
          return;
        }

        tbody.innerHTML = recentClicks
          .map(
            (click) => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${new Date(click.timestamp).toLocaleString()}
          </td>
          <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-gray-900 hidden sm:table-cell">
            ${click.city}, ${click.country}
          </td>
          <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-gray-900 hidden md:table-cell">
            ${click.device}
          </td>
          <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-gray-900 hidden lg:table-cell">
            ${click.browser}
          </td>
          <td class="px-4 md:px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden xl:table-cell">
            ${click.referer}
          </td>
        </tr>
      `
          )
          .join("");
      }

      // Load analytics from URL hash on page load
      window.addEventListener("load", () => {
        const hash = window.location.hash.substring(1);
        if (hash) {
          currentShortCode = hash;
          loadAnalytics(hash);
        }
      });
    </script>
  </body>
</html>
